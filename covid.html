<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Covid</title>
    
    <script src="https://d3js.org/d3.v5.min.js"></script>  
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
    
    <style type="text/css">
        
    </style>
</head>

<body>
    <input type="radio" id="confirmed" name="mode" value="confirmed" onclick="redraw();" checked="true"><label for="confirmed">Confirmed</label>
    <input type="radio" id="deaths" name="mode" value="deaths" onclick="redraw();"><label for="deaths">Deaths</label>

    <div id="divSvg"></div>
    
    <script>
        let replaceToken = "###";
        let baseUrl = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/" + 
        `csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_${replaceToken}_global.csv`
        let deathsUrl = baseUrl.replace("###", "deaths");
        let confirmedUrl = baseUrl.replace("###", "confirmed");
        
        let deaths = null;
        let confirmed = null;
                
        let chart = d3.select("#divSvg")
        .append("svg")
        .attr("width", 1200)
        .attr("height", 800)
        .attr("style", "background-color: #ccc")
        .on("wheel", function(d){
            var direction = d3.event.wheelDelta < 0 ? 'down' : 'up';
            zoom(direction === 'up' ? 1 : -1);
        });


        let yScale = 0.0002;  // TODO: this should be calculated based on largest value (largest of the latest values)
        let hoffset = 500;
        let hscale = 8;
        
        
        function loadData(text) {
            let lines = text.match(/[^\r\n]+/g);
            let records = lines.slice(1);
            let result = {};
            for (let ri in records) {
                let record = records[ri].split(',');
                let countryName = record[1];
                if (record[0].length > 0) {
                    countryName += ` (${record[0]})`;
                }
                cases = record.slice(4).map(parseFloat);
                result[countryName] = cases;
            }
            return result;
        }

        function zoom(direction) {
            yScale *= (1 + (direction * 0.2));
            redraw();
        }
        
        function redraw() {
            let mode = document.querySelector('input[name="mode"]:checked').value;
            console.log(mode)
            let records = null;
            switch (mode) {
                case "confirmed": records = confirmed; break;
                case "deaths": records = deaths; break;                
            }
            
            d3.selectAll(".refreshable").remove();

            for (let countryName in records) {
                let cases = records[countryName];
                
                let color = "gray"
                switch (countryName) {
                    case "Brazil": color = "green"; break;
                    case "US": color = "red"; break;
                }
                
                chart.append("path")
                .classed("refreshable", true)
                .attr("stroke", color)
                .attr("fill", "none")
                .attr("d", d3.line()(cases.map((v,i) => [i*hscale - hoffset, 800 - v*yScale])))
                
                chart.append("text")
                .classed("refreshable", true)
                .attr("x", cases.length * hscale - hoffset)
                .attr("y", 800-(cases[cases.length-1]*yScale))
                .text(countryName);
            }        
        }
        
        
        fetch(deathsUrl).then(response => response.text()).then(   text => { deaths    = loadData(text); redraw(); });
        fetch(confirmedUrl).then(response => response.text()).then(text => { confirmed = loadData(text); redraw(); });
        
        
        // fetch("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
        // .then(response => response.text())
        // .then(text => {
            
            //     let chart = d3.select("#divSvg")
            //     .append("svg")
            //     .attr("width", 1200)
            //     .attr("height", 800)
            //     .attr("style", "background-color: #ccc");
            
            //     let lines = text.match(/[^\r\n]+/g);
            
            //     let records = lines.slice(1)
            
            //     let yScale = 0.0002;
            //     let hoffset = 500;
            //     let hscale = 8;
            
            //     for (let ri in records)
            //     {
                //         let record = records[ri].split(',');
                //         let countryName = record[1];
                //         if (record[0].length > 0) {
                    //             countryName += ` (${record[0]})`;
                    //         }
                    
                    //         cases = record.slice(4).map(parseFloat);
                    
                    //         let color = "gray"
                    //         switch (countryName) {
                        //             case "Brazil": color = "green"; break;
                        //             case "US": color = "red"; break;
                        //         }
                        
                        //         chart.append("path")
                        //         .attr("stroke", color)
                        //         .attr("fill", "none")
                        //         .attr("d", d3.line()(cases.map((v,i) => [i*hscale - hoffset, 800 - v*yScale])))
                        
                        //         chart.append("text")
                        //         .attr("x", cases.length * hscale - hoffset)
                        //         .attr("y", 800-(cases[cases.length-1]*yScale))
                        //         .text(countryName);
                        
                        
                        //         //console.log(countryName);
                        //         //console.log(cases)
                        //     }
                        
                        // });
                    </script>
                </body>
                </html>
                